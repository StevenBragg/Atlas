name: Deploy to Salad Cloud

on:
  workflow_dispatch:
    inputs:
      gpu_class:
        description: 'GPU Type'
        required: true
        default: 'rtx3060'
        type: choice
        options:
          - rtx3060
          - rtx3070
          - rtx3080
          - rtx3090
      replicas:
        description: 'Number of instances'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/atlas-salad
  SALAD_ORG: stevenbragg

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - Check Secrets
        run: |
          echo "Checking if SALAD_API_KEY is set..."
          if [ -n "${{ secrets.SALAD_API_KEY }}" ]; then
            echo "✅ SALAD_API_KEY is set"
            echo "Length: ${#SALAD_API_KEY}"
          else
            echo "❌ SALAD_API_KEY is NOT set"
          fi
        env:
          SALAD_API_KEY: ${{ secrets.SALAD_API_KEY }}

      - name: Deploy to Salad Cloud
        env:
          SALAD_API_KEY: ${{ secrets.SALAD_API_KEY }}
        run: |
          set -x  # Enable debug mode
          
          GPU_CLASS="${{ github.event.inputs.gpu_class }}"
          REPLICAS="${{ github.event.inputs.replicas }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "=== Deployment Configuration ==="
          echo "GPU: $GPU_CLASS"
          echo "Replicas: $REPLICAS"
          echo "Image: $IMAGE"
          echo "Organization: ${{ env.SALAD_ORG }}"
          echo ""
          
          # Test API connectivity
          echo "=== Testing Salad Cloud API ==="
          curl -s -o /dev/null -w "%{http_code}" \
            -H "Salad-Api-Key: $SALAD_API_KEY" \
            https://api.salad.com/api/public/organizations/${{ env.SALAD_ORG }} \
            || echo "API test failed"
          echo ""
          
          # Try to create project
          echo "=== Creating/Checking Project ==="
          PROJECT_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Salad-Api-Key: $SALAD_API_KEY" \
            https://api.salad.com/api/public/organizations/${{ env.SALAD_ORG }}/projects/atlas)
          echo "Project check response: $PROJECT_RESPONSE"
          
          # Create container group
          echo "=== Creating Container Group ==="
          curl -v -X POST \
            -H "Salad-Api-Key: $SALAD_API_KEY" \
            -H "Content-Type: application/json" \
            https://api.salad.com/api/public/organizations/${{ env.SALAD_ORG }}/projects/atlas/container-groups \
            -d "{
              \"name\": \"atlas-gpu-$GPU_CLASS\",
              \"container\": {
                \"image\": \"$IMAGE\",
                \"resources\": {
                  \"cpu\": 4,
                  \"memory\": 8192,
                  \"gpu_class\": \"$GPU_CLASS\",
                  \"storage_amount\": 10
                },
                \"port\": 8080
              },
              \"replicas\": $REPLICAS
            }" 2>&1
