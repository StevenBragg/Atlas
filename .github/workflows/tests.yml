name: ATLAS Unified Super Intelligence CI/CD

on:
  push:
    branches: [ main, develop, 'claude/*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      run_full_model:
        description: 'Run full model execution test'
        required: false
        default: 'true'
        type: boolean
      run_extended_tests:
        description: 'Run extended test suite'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHONPATH: ${{ github.workspace }}/self_organizing_av_system

jobs:
  # ============================================
  # Core Unit Tests - Phase 1 Cognitive Systems
  # ============================================
  test-phase1:
    name: Phase 1 Cognitive Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r self_organizing_av_system/requirements_no_audio.txt
        pip install pytest pytest-cov pytest-timeout pytest-xdist

    - name: Run Phase 1 Cognitive Systems Tests
      run: |
        cd self_organizing_av_system
        python -m pytest tests/test_cognitive_systems.py -v --timeout=300 --tb=short -x
      continue-on-error: false

    - name: Upload Phase 1 test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: phase1-results-py${{ matrix.python-version }}
        path: self_organizing_av_system/.pytest_cache/

  # ============================================
  # Core Unit Tests - Phase 2 Cognitive Systems
  # ============================================
  test-phase2:
    name: Phase 2 Cognitive Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r self_organizing_av_system/requirements_no_audio.txt
        pip install pytest pytest-cov pytest-timeout pytest-xdist

    - name: Run Phase 2 Cognitive Systems Tests
      run: |
        cd self_organizing_av_system
        python -m pytest tests/test_phase2_cognitive_systems.py -v --timeout=300 --tb=short -x
      continue-on-error: false

  # ============================================
  # Unified Super Intelligence Tests
  # ============================================
  test-unified-intelligence:
    name: Unified Intelligence Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r self_organizing_av_system/requirements_no_audio.txt
        pip install pytest pytest-cov pytest-timeout pytest-xdist

    - name: Run Unified Super Intelligence Tests
      run: |
        cd self_organizing_av_system
        python -m pytest tests/test_unified_intelligence.py -v --timeout=600 --tb=short
      continue-on-error: false

  # ============================================
  # Full Test Suite with Coverage
  # ============================================
  test-full-coverage:
    name: Full Test Suite with Coverage
    runs-on: ubuntu-latest
    needs: [test-phase1, test-phase2, test-unified-intelligence]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r self_organizing_av_system/requirements_no_audio.txt
        pip install pytest pytest-cov pytest-timeout pytest-xdist coverage

    - name: Run All Tests with Coverage
      run: |
        cd self_organizing_av_system
        python -m pytest tests/ -v \
          --ignore=tests/test_structural_sync.py \
          --ignore=tests/test_system.py \
          --cov=core \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --timeout=900 \
          --tb=short
      continue-on-error: true

    - name: Upload coverage report
      uses: codecov/codecov-action@v4
      with:
        files: ./self_organizing_av_system/coverage.xml
        flags: unittests
        name: atlas-coverage
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload HTML coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: self_organizing_av_system/htmlcov/

  # ============================================
  # Full Model Execution Test
  # ============================================
  run-full-model:
    name: Full Model Execution
    runs-on: ubuntu-latest
    needs: [test-phase1, test-phase2, test-unified-intelligence]
    if: github.event.inputs.run_full_model != 'false'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsndfile1

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r self_organizing_av_system/requirements_no_audio.txt
        pip install pytest pytest-timeout

    - name: Run Unified Super Intelligence Model
      run: |
        cd self_organizing_av_system
        python -c "
        import numpy as np
        from core.unified_intelligence import UnifiedSuperIntelligence, IntelligenceMode

        print('=' * 70)
        print('ATLAS UNIFIED SUPER INTELLIGENCE MODEL EXECUTION')
        print('=' * 70)

        # Initialize the unified super intelligence
        print('\n[1] Initializing Unified Super Intelligence...')
        usi = UnifiedSuperIntelligence(
            state_dim=64,
            max_memory_capacity=1000,
            learning_rate=0.01,
            enable_self_improvement=True,
            enable_creativity=True,
            enable_social_cognition=True,
            random_seed=42
        )
        print('    Systems initialized successfully!')

        # Run cognitive processing cycles
        print('\n[2] Running cognitive processing cycles...')
        for i in range(10):
            sensory_input = {
                'visual': np.random.rand(64),
                'audio': np.random.rand(64)
            }
            result = usi.process(
                sensory_input=sensory_input,
                mode=IntelligenceMode.UNIFIED
            )
            print(f'    Cycle {i+1}: {len(result[\"phases_completed\"])} phases completed')

        # Test thinking capability
        print('\n[3] Testing thinking capability...')
        think_result = usi.think(
            query='How can the system optimize its learning?',
            depth=3
        )
        print(f'    Reasoning chain: {len(think_result[\"reasoning_chain\"])} steps')
        print(f'    Confidence: {think_result[\"confidence\"]:.2f}')

        # Test imagination
        print('\n[4] Testing imagination capability...')
        imagine_result = usi.imagine(
            scenario='Future capability enhancement',
            steps=5
        )
        print(f'    Trajectory length: {imagine_result[\"trajectory_length\"]}')
        print(f'    Plausibility: {imagine_result[\"plausibility\"]:.2f}')
        print(f'    Novelty: {imagine_result[\"novelty\"]:.2f}')

        # Test social cognition
        print('\n[5] Testing social cognition...')
        agent_result = usi.model_agent(
            agent_id='test_agent',
            observations=[
                (np.random.rand(64), np.random.rand(64))
                for _ in range(5)
            ]
        )
        print(f'    Observations processed: {agent_result[\"observations_processed\"]}')

        # Test self-improvement
        print('\n[6] Testing self-improvement...')
        improve_result = usi.improve_self(n_cycles=2)
        print(f'    Cycles run: {improve_result[\"cycles_run\"]}')
        print(f'    Total proposals: {improve_result[\"total_proposals\"]}')

        # Get final metrics
        print('\n[7] Final Intelligence Metrics:')
        metrics = usi.get_metrics()
        for metric, value in metrics.items():
            print(f'    {metric}: {value:.4f}')

        # Get comprehensive stats
        print('\n[8] System Statistics:')
        stats = usi.get_stats()
        print(f'    Total cycles: {stats[\"total_cycles\"]}')
        print(f'    Total experiences: {stats[\"total_experiences\"]}')
        print(f'    Total decisions: {stats[\"total_decisions\"]}')
        print(f'    Total learning updates: {stats[\"total_learning_updates\"]}')

        print('\n' + '=' * 70)
        print('UNIFIED SUPER INTELLIGENCE MODEL EXECUTION COMPLETE')
        print('=' * 70)
        print(f'\nUnified Intelligence Quotient: {metrics[\"unified_intelligence_quotient\"]:.4f}')
        "
      timeout-minutes: 10

  # ============================================
  # Code Quality - Linting
  # ============================================
  lint:
    name: Code Quality (Linting)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 pylint

    - name: Run flake8 (syntax and style check)
      run: |
        flake8 self_organizing_av_system/core --count --select=E9,F63,F7,F82 --show-source --statistics
      continue-on-error: true

    - name: Run pylint (code quality)
      run: |
        pylint self_organizing_av_system/core --exit-zero --disable=C,R --max-line-length=120
      continue-on-error: true

  # ============================================
  # Integration Tests
  # ============================================
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [test-phase1, test-phase2, test-unified-intelligence]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r self_organizing_av_system/requirements_no_audio.txt
        pip install pytest pytest-timeout

    - name: Run Phase 1 Integration Tests
      run: |
        cd self_organizing_av_system
        python -m pytest tests/test_cognitive_systems.py::TestCognitiveIntegration -v --timeout=300

    - name: Run Phase 2 Integration Tests
      run: |
        cd self_organizing_av_system
        python -m pytest tests/test_phase2_cognitive_systems.py::TestPhase2Integration -v --timeout=300

    - name: Run Phase 1/2 Integration Tests
      run: |
        cd self_organizing_av_system
        python -m pytest tests/test_phase2_cognitive_systems.py::TestPhase1Phase2Integration -v --timeout=300

    - name: Run Unified Intelligence Integration Tests
      run: |
        cd self_organizing_av_system
        python -m pytest tests/test_unified_intelligence.py::TestCrossSystemIntegration -v --timeout=300
        python -m pytest tests/test_unified_intelligence.py::TestFullSupertintelligencePipeline -v --timeout=300

  # ============================================
  # Documentation Check
  # ============================================
  documentation:
    name: Documentation Validation
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check documentation exists
      run: |
        echo "Checking for required documentation..."
        test -f README.md && echo "✓ README.md exists"
        test -f SUPERINTELLIGENCE_ANALYSIS.md && echo "✓ SUPERINTELLIGENCE_ANALYSIS.md exists"
        test -f self_organizing_av_system/README.md && echo "✓ Package README exists" || echo "✗ Package README missing"
        test -f self_organizing_av_system/core/unified_intelligence.py && echo "✓ Unified Intelligence module exists"
        echo "Documentation check complete!"

  # ============================================
  # Final Summary
  # ============================================
  summary:
    name: CI/CD Summary
    runs-on: ubuntu-latest
    needs: [test-phase1, test-phase2, test-unified-intelligence, test-full-coverage, lint, integration-test, documentation]
    if: always()
    steps:
    - name: Generate Test Summary
      run: |
        echo "# ATLAS Unified Super Intelligence CI/CD Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Phase 1 Cognitive Tests | ${{ needs.test-phase1.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Phase 2 Cognitive Tests | ${{ needs.test-phase2.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Unified Intelligence Tests | ${{ needs.test-unified-intelligence.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Full Coverage Suite | ${{ needs.test-full-coverage.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Linting | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Integration Tests | ${{ needs.integration-test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Documentation | ${{ needs.documentation.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Cognitive Systems Tested" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Phase 1 (Foundation)" >> $GITHUB_STEP_SUMMARY
        echo "- Episodic Memory" >> $GITHUB_STEP_SUMMARY
        echo "- Semantic Memory" >> $GITHUB_STEP_SUMMARY
        echo "- Working Memory" >> $GITHUB_STEP_SUMMARY
        echo "- Meta-Learning" >> $GITHUB_STEP_SUMMARY
        echo "- Goal Planning" >> $GITHUB_STEP_SUMMARY
        echo "- Causal Reasoning" >> $GITHUB_STEP_SUMMARY
        echo "- Abstract Reasoning" >> $GITHUB_STEP_SUMMARY
        echo "- Language Grounding" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Phase 2 (Advanced)" >> $GITHUB_STEP_SUMMARY
        echo "- World Model" >> $GITHUB_STEP_SUMMARY
        echo "- Executive Control" >> $GITHUB_STEP_SUMMARY
        echo "- Creativity Engine" >> $GITHUB_STEP_SUMMARY
        echo "- Theory of Mind" >> $GITHUB_STEP_SUMMARY
        echo "- Recursive Self-Improvement" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Unified Super Intelligence" >> $GITHUB_STEP_SUMMARY
        echo "- Complete Cognitive Integration" >> $GITHUB_STEP_SUMMARY
        echo "- Multi-Phase Processing" >> $GITHUB_STEP_SUMMARY
        echo "- Cross-System Communication" >> $GITHUB_STEP_SUMMARY
        echo "- Intelligence Metrics" >> $GITHUB_STEP_SUMMARY
        echo "- Thinking & Reasoning" >> $GITHUB_STEP_SUMMARY
        echo "- Imagination & Creativity" >> $GITHUB_STEP_SUMMARY
        echo "- Social Cognition" >> $GITHUB_STEP_SUMMARY
        echo "- Self-Improvement" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Architecture" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "┌─────────────────────────────────────────────────────────────────┐" >> $GITHUB_STEP_SUMMARY
        echo "│                    METACOGNITIVE LAYER                         │" >> $GITHUB_STEP_SUMMARY
        echo "│  Self-Improvement │ Meta-Learning │ Monitoring                 │" >> $GITHUB_STEP_SUMMARY
        echo "├─────────────────────────────────────────────────────────────────┤" >> $GITHUB_STEP_SUMMARY
        echo "│                    EXECUTIVE LAYER                              │" >> $GITHUB_STEP_SUMMARY
        echo "│  Executive Control │ Goal Planning │ Working Memory            │" >> $GITHUB_STEP_SUMMARY
        echo "├─────────────────────────────────────────────────────────────────┤" >> $GITHUB_STEP_SUMMARY
        echo "│                    REASONING LAYER                              │" >> $GITHUB_STEP_SUMMARY
        echo "│  Causal Reasoning │ Abstract Reasoning │ Creativity            │" >> $GITHUB_STEP_SUMMARY
        echo "├─────────────────────────────────────────────────────────────────┤" >> $GITHUB_STEP_SUMMARY
        echo "│                    KNOWLEDGE LAYER                              │" >> $GITHUB_STEP_SUMMARY
        echo "│  Episodic Memory │ Semantic Memory │ World Model               │" >> $GITHUB_STEP_SUMMARY
        echo "├─────────────────────────────────────────────────────────────────┤" >> $GITHUB_STEP_SUMMARY
        echo "│                    SOCIAL LAYER                                 │" >> $GITHUB_STEP_SUMMARY
        echo "│  Theory of Mind │ Language Grounding                           │" >> $GITHUB_STEP_SUMMARY
        echo "├─────────────────────────────────────────────────────────────────┤" >> $GITHUB_STEP_SUMMARY
        echo "│                    SENSORY LAYER                                │" >> $GITHUB_STEP_SUMMARY
        echo "│  Visual Processing │ Audio Processing │ Multimodal Association │" >> $GITHUB_STEP_SUMMARY
        echo "└─────────────────────────────────────────────────────────────────┘" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
