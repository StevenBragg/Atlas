name: Deploy to Salad Cloud

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      gpu_class:
        description: 'GPU Type'
        required: true
        default: 'rtx3060'
        type: choice
        options:
          - rtx3060
          - rtx3070
          - rtx3080
          - rtx3090
      replicas:
        description: 'Number of instances'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/atlas-salad
  SALAD_ORG: stevenbragg
  PROJECT: atlas

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Salad Cloud
        env:
          SALAD_API_KEY: ${{ secrets.SALAD_API_KEY }}
        run: |
          GPU_INPUT="${{ github.event.inputs.gpu_class || 'rtx3060' }}"
          REPLICAS="${{ github.event.inputs.replicas || '1' }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

          # Map GPU names to Salad Cloud UUIDs
          case "$GPU_INPUT" in
            rtx3060) GPU_CLASS="f51baccc-dc95-40fb-a5d1-6d0ee0db31d2" ;;
            rtx3070) GPU_CLASS="951131f6-5acf-489c-b303-0906be8b26ef" ;;
            rtx3080) GPU_CLASS="43a49c0c-f860-40e9-a509-702d0dba0902" ;;
            rtx3090) GPU_CLASS="a5db5c50-cbcb-4596-ae80-6a0c8090d80f" ;;
            *) echo "Unknown GPU class: $GPU_INPUT"; exit 1 ;;
          esac

          echo "=== Deploying Atlas to Salad Cloud ==="
          echo "GPU: $GPU_INPUT ($GPU_CLASS)"
          echo "Replicas: $REPLICAS"
          echo "Image: $IMAGE"
          echo ""

          # Check if container group already exists
          CHECK=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Salad-Api-Key: $SALAD_API_KEY" \
            "https://api.salad.com/api/public/organizations/${{ env.SALAD_ORG }}/projects/${{ env.PROJECT }}/containers/atlas-gpu-$GPU_INPUT")

          if [ "$CHECK" = "200" ]; then
            echo "Container group already exists, updating..."
            METHOD="PATCH"
            URL="https://api.salad.com/api/public/organizations/${{ env.SALAD_ORG }}/projects/${{ env.PROJECT }}/containers/atlas-gpu-$GPU_INPUT"
          else
            echo "Creating new container group..."
            METHOD="POST"
            URL="https://api.salad.com/api/public/organizations/${{ env.SALAD_ORG }}/projects/${{ env.PROJECT }}/containers"
          fi

          # Deploy container group with networking enabled
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X "$METHOD" \
            -H "Salad-Api-Key: $SALAD_API_KEY" \
            -H "Content-Type: application/json" \
            "$URL" \
            -d "{
              \"name\": \"atlas-gpu-$GPU_INPUT\",
              \"display_name\": \"Atlas GPU ($GPU_INPUT)\",
              \"container\": {
                \"image\": \"$IMAGE\",
                \"resources\": {
                  \"cpu\": 4,
                  \"memory\": 8192,
                  \"gpu_classes\": [\"$GPU_CLASS\"],
                  \"storage_amount\": 10737418240
                },
                \"environment_variables\": {
                  \"ATLAS_ENABLE_TEXT_LEARNING\": \"true\",
                  \"ATLAS_HTTP_PORT\": \"8080\",
                  \"ATLAS_LOG_LEVEL\": \"INFO\"
                }
              },
              \"replicas\": $REPLICAS,
              \"networking\": {
                \"protocol\": \"http\",
                \"port\": 8080,
                \"auth\": false,
                \"load_balancer\": \"round_robin\"
              },
              \"probes\": {
                \"startup\": {
                  \"http\": {
                    \"path\": \"/health\",
                    \"port\": 8080
                  },
                  \"initial_delay_seconds\": 60,
                  \"period_seconds\": 10,
                  \"timeout_seconds\": 5,
                  \"success_threshold\": 1,
                  \"failure_threshold\": 30
                },
                \"liveness\": {
                  \"http\": {
                    \"path\": \"/health\",
                    \"port\": 8080
                  },
                  \"initial_delay_seconds\": 0,
                  \"period_seconds\": 30,
                  \"timeout_seconds\": 10,
                  \"success_threshold\": 1,
                  \"failure_threshold\": 3
                },
                \"readiness\": {
                  \"http\": {
                    \"path\": \"/health\",
                    \"port\": 8080
                  },
                  \"initial_delay_seconds\": 0,
                  \"period_seconds\": 10,
                  \"timeout_seconds\": 5,
                  \"success_threshold\": 1,
                  \"failure_threshold\": 3
                }
              }
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response (HTTP $HTTP_CODE):"
          echo "$BODY" | python3 -m json.tool 2>/dev/null || echo "$BODY"

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            # Extract the access domain name from the response
            ACCESS_DOMAIN=$(echo "$BODY" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('networking',{}).get('dns','N/A'))" 2>/dev/null || echo "N/A")
            echo ""
            echo "✅ Deployment successful!"
            echo "Access URL: https://$ACCESS_DOMAIN"
            echo "Portal: https://portal.salad.com/organizations/${{ env.SALAD_ORG }}/projects/${{ env.PROJECT }}"
          else
            echo ""
            echo "❌ Deployment failed (HTTP $HTTP_CODE)"
            exit 1
          fi
