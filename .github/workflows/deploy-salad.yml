name: Deploy to Salad Cloud

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      gpu_class:
        description: 'GPU Type'
        required: true
        default: 'rtx3060'
        type: choice
        options:
          - rtx3060
          - rtx3070
          - rtx3080
          - rtx3090
      replicas:
        description: 'Number of instances'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/atlas-salad
  SALAD_ORG: stevenbragg
  PROJECT: atlas

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Salad Cloud
        env:
          SALAD_API_KEY: ${{ secrets.SALAD_API_KEY }}
        run: |
          GPU_INPUT="${{ github.event.inputs.gpu_class || 'rtx3060' }}"
          REPLICAS="${{ github.event.inputs.replicas || '1' }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          CONTAINER_NAME="atlas-gpu-$GPU_INPUT"

          # Map GPU class to UUID
          case "$GPU_INPUT" in
            rtx3060) GPU_UUID="f51baccc-dc95-40fb-a5d1-6d0ee0db31d2" ;;
            rtx3070) GPU_UUID="951131f6-5acf-489c-b303-0906be8b26ef" ;;
            rtx3080) GPU_UUID="43a49c0c-f860-40e9-a509-702d0dba0902" ;;
            rtx3090) GPU_UUID="a5db5c50-cbcb-4596-ae80-6a0c8090d80f" ;;
            *) echo "Unknown GPU class: $GPU_INPUT"; exit 1 ;;
          esac

          echo "=== Deploying Atlas to Salad Cloud ==="
          echo "GPU: $GPU_INPUT ($GPU_UUID)"
          echo "Replicas: $REPLICAS"
          echo "Image: $IMAGE"
          echo ""

          CONTAINER_URL="https://api.salad.com/api/public/organizations/${{ env.SALAD_ORG }}/projects/${{ env.PROJECT }}/containers/$CONTAINER_NAME"

          PAYLOAD=$(cat <<EOFPAYLOAD
          {
            "name": "$CONTAINER_NAME",
            "display_name": "Atlas GPU $GPU_INPUT",
            "container": {
              "image": "$IMAGE",
              "resources": {
                "cpu": 4,
                "memory": 8192,
                "gpu_classes": ["$GPU_UUID"],
                "storage_amount": 10737418240
              },
              "environment_variables": {
                "ATLAS_ENABLE_TEXT_LEARNING": "true"
              }
            },
            "autostart_policy": true,
            "restart_policy": "always",
            "replicas": $REPLICAS,
            "networking": {
              "protocol": "http",
              "port": 8080,
              "auth": false
            },
            "startup_probe": {
              "http": {
                "path": "/health",
                "port": 8080,
                "scheme": "http",
                "headers": []
              },
              "initial_delay_seconds": 30,
              "period_seconds": 10,
              "timeout_seconds": 5,
              "failure_threshold": 10
            },
            "liveness_probe": {
              "http": {
                "path": "/health",
                "port": 8080,
                "scheme": "http",
                "headers": []
              },
              "initial_delay_seconds": 60,
              "period_seconds": 30,
              "timeout_seconds": 10,
              "failure_threshold": 3
            },
            "readiness_probe": {
              "http": {
                "path": "/ready",
                "port": 8080,
                "scheme": "http",
                "headers": []
              },
              "initial_delay_seconds": 60,
              "period_seconds": 30,
              "timeout_seconds": 10,
              "failure_threshold": 3
            }
          }
          EOFPAYLOAD
          )

          # Check if the container group already exists
          echo "Checking if container group '$CONTAINER_NAME' exists..."
          CHECK_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Salad-Api-Key: $SALAD_API_KEY" \
            "$CONTAINER_URL")

          CHECK_CODE=$(echo "$CHECK_RESPONSE" | tail -n1)

          if [ "$CHECK_CODE" = "200" ]; then
            echo "Container group exists, updating with PATCH..."
            METHOD="-X PATCH"
          else
            echo "Container group not found, creating with POST..."
            METHOD="-X POST"
            CONTAINER_URL="https://api.salad.com/api/public/organizations/${{ env.SALAD_ORG }}/projects/${{ env.PROJECT }}/containers"
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            $METHOD \
            -H "Salad-Api-Key: $SALAD_API_KEY" \
            -H "Content-Type: application/json" \
            "$CONTAINER_URL" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n-1)

          echo "Response (HTTP $HTTP_CODE):"
          echo "$BODY" | python3 -m json.tool 2>/dev/null || echo "$BODY"

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            # Extract the access domain name from the response
            ACCESS_DOMAIN=$(echo "$BODY" | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('networking',{}).get('dns','N/A'))" 2>/dev/null || echo "N/A")
            echo ""
            echo "Deployment successful!"
            echo "Monitor at: https://portal.salad.com/organizations/${{ env.SALAD_ORG }}/projects/${{ env.PROJECT }}"
          else
            echo ""
            echo "Deployment failed (HTTP $HTTP_CODE)"
            exit 1
          fi
