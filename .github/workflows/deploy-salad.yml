name: Deploy to Salad Cloud

on:
  push:
    branches: [main, master]
    paths:
      - 'Dockerfile.salad'
      - 'self_organizing_av_system/**'
      - 'cloud/**'
      - 'config/**'
      - '.github/workflows/deploy-salad.yml'
  workflow_dispatch:
    inputs:
      gpu_class:
        description: 'GPU Type'
        required: true
        default: 'rtx3060'
        type: choice
        options:
          - rtx3060
          - rtx3070
          - rtx3080
          - rtx3090
      replicas:
        description: 'Number of instances'
        required: true
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/atlas-salad
  SALAD_ORG: stevenbragg  # Update this if different

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to Salad Cloud
        env:
          SALAD_API_KEY: ${{ secrets.SALAD_API_KEY }}
        run: |
          # Install Salad Cloud CLI via npm
          npm install -g @saladtechnologies/salad-cloud-cli
          
          # Set variables
          GPU_CLASS="${{ github.event.inputs.gpu_class || 'rtx3060' }}"
          REPLICAS="${{ github.event.inputs.replicas || '1' }}"
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          
          echo "Deploying Atlas to Salad Cloud..."
          echo "GPU: $GPU_CLASS"
          echo "Replicas: $REPLICAS"
          echo "Image: $IMAGE"
          
          # Create container group using Salad Cloud API directly
          curl -s -X POST \
            -H "Salad-Api-Key: $SALAD_API_KEY" \
            -H "Content-Type: application/json" \
            https://api.salad.com/api/public/organizations/${{ env.SALAD_ORG }}/projects/atlas/container-groups \
            -d "{
              \"name\": \"atlas-gpu-$GPU_CLASS\",
              \"container\": {
                \"image\": \"$IMAGE\",
                \"resources\": {
                  \"cpu\": 4,
                  \"memory\": 8192,
                  \"gpu_class\": \"$GPU_CLASS\",
                  \"storage_amount\": 10
                },
                \"port\": 8080
              },
              \"replicas\": $REPLICAS,
              \"country_codes\": [\"US\", \"CA\"],
              \"restart_policy\": \"always\",
              \"readiness_probe\": {
                \"http\": {
                  \"port\": 8080,
                  \"path\": \"/health\"
                },
                \"initial_delay_seconds\": 30,
                \"period_seconds\": 30,
                \"timeout_seconds\": 10,
                \"failure_threshold\": 3
              }
            }" || echo "Container group may already exist, trying update..."
          
          echo "âœ… Deployment complete!"
          echo ""
          echo "Monitor at: https://portal.salad.com/organizations/${{ env.SALAD_ORG }}/projects/atlas"
